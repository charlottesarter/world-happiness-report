---
title: "Test pour le projet d'IF36 par Charlotte"
author: "Charlotte Sarter"
date: '2022-03-22'
output: 
  prettydoc::html_pretty:
    theme: cayman
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction

Ce projet est réalisé dans le cadre de la matière **Visualisation de données** enseignée à l'Université de Technologie de Troyes.

## Lien des datasets

- [World Happiness Report](https://www.kaggle.com/datasets/unsdsn/world-happiness?select=2017.csv) (de 2015 à 2019)
- [World Happiness Report](https://www.kaggle.com/datasets/londeen/world-happiness-report-2020) (2020)
- [World Happiness Report](https://www.kaggle.com/datasets/ajaypalsinghlo/world-happiness-report-2021?select=world-happiness-report-2021.csv) (2021)
- [Healthy Lifestyle Cities Report 2021](https://www.kaggle.com/datasets/prasertk/healthy-lifestyle-cities-report-2021) 

> Le dernier dataset apporte des indicateurs supplémentaires sur ce qui est susceptible de provoquer le bonheur des populations (prix de la vie, soleil, obésité...). Cependant, il ne comporte uniquement des données de 2021, ainsi nous pourrons seulement le comparer avec le second dataset, qui comporte les données du World Happiness Report de 2021. Nous pourrions ainsi apporter une nouvelle dimension à notre analyse.

![World Happiness Report](https://www.sogeti.com/globalassets/common/1980x660-large-background-image/sogeti/worldhappinessreport2019-1980x660.jpg)

### Données

Le jeu de données que nous avons choisi d'étudier est issu d'une enquête de référence sur l'état du bonheur dans le monde. Il comporte des données de 2015 à 2020, et classe 155 pays selon leur niveau de bonheur. Il permet d'établir une corrélation entre différents critères (liberté, corruption, cadre de vie...) et le niveau de bonheur qui en découle.

## Nettoyage des données

La première étape du projet est certainement une des plus importantes. 

Nous avons commencé par analyser tous les datasets pour voir si les données nommées de la même manière correspondent à la même chose (ce qui n'était pas toujours le cas). Nous avons ensuite renommé toutes les colonnes de tous les datasets de la même manière selon la convention définie ci-dessous. Enfin, nous avons fusionné l'ensemble des datasets de manière à travailler sur un seul tableau propre à l'aide de filtres par la suite.

## Convention de nommage des colonnes

- Le nom des colonnes commence par une majuscule
- Les espaces sont remplacés par un underscore "_"

```{r cleaning}
library(readr)
library(dplyr)
library(ggplot2)
library(leaflet)
library(sf)
library(rmapshaper)
library(prettydoc)

# Importation des datasets

data2015 <- tibble(read_csv('../data/2015.csv'))
data2016 <- tibble(read_csv('../data/2016.csv'))
data2017 <- tibble(read_csv('../data/2017.csv'))
data2018 <- tibble(read_csv('../data/2018.csv'))
data2019 <- tibble(read_csv('../data/2019.csv'))
data2020 <- tibble(read_csv('../data/2020.csv'))
data2021 <- tibble(read_csv('../data/2021.csv'))
countries <- tibble(read_csv('../data/countries.csv'))
world_map <- read_sf('../data/world_map')

# Nettoyage du dataset "countries" pour pouvoir ajouter les coordonnées géographiques des pays

countries_corrected <- countries %>%
  rename(Country_code =`country`, 
         Latitude = `latitude`,
         Longitude = `longitude`,
         Country = `name`)

# Nettoyage du dataset "world_map" pour pouvoir manipuler les régions du monde sur une carte

world_map_corrected <- world_map %>%
  rename(Country =`NAME`, 
         Geometry = `geometry`)

# Renommage des colonnes (selon la convention définie précedemment) & ajout de la colonne "year" 

data2015_corrected <- data2015 %>% 
  mutate(lower_confidence_interval = `Happiness Score` - `Standard Error`, upper_confidence_interval = `Happiness Score` + `Standard Error`, Year = 2015) %>%
  rename(Happiness_rank =`Happiness Rank`, 
         Happiness_score = `Happiness Score`,
         Standard_error = `Standard Error`,
         Exp_by_economy_gdp_per_capita = `Economy (GDP per Capita)`,
         Explained_by_social_support = Family,
         Explained_by_life_expectancy = `Health (Life Expectancy)`,
         Explained_by_freedom = Freedom,
         Explained_by_trust_government = `Trust (Government Corruption)`,
         Explained_by_generosity = Generosity,
         Dystopia_residual = `Dystopia Residual`)

data2016_corrected <- data2016 %>% 
  mutate(Standard.Error = `Happiness Score` - `Lower Confidence Interval`, Year = 2016) %>%
  rename(Happiness_rank = `Happiness Rank`, 
         Happiness_score = `Happiness Score`,
         Standard_error = Standard.Error,
         Exp_by_economy_gdp_per_capita = `Economy (GDP per Capita)`,
         Explained_by_social_support = Family,
         Explained_by_life_expectancy = `Health (Life Expectancy)`,
         Explained_by_freedom = Freedom,
         Explained_by_trust_government = `Trust (Government Corruption)`,
         Explained_by_generosity = Generosity,
         Dystopia_residual = `Dystopia Residual`,
         Lower_confidence_interval = `Lower Confidence Interval`,
         Upper_confidence_interval = `Upper Confidence Interval`)

data2017_corrected <- data2017 %>% 
  mutate(Standard_error = Happiness.Score - Whisker.low, Year = 2017) %>%
  rename(Happiness_rank = Happiness.Rank, 
         Happiness_score = Happiness.Score,
         Exp_by_economy_gdp_per_capita = Economy..GDP.per.Capita.,
         Explained_by_social_support = Family,
         Explained_by_life_expectancy = Health..Life.Expectancy.,
         Explained_by_freedom = Freedom,
         Explained_by_trust_government = Trust..Government.Corruption.,
         Explained_by_generosity = Generosity,
         Dystopia_residual = Dystopia.Residual,
         Lower_confidence_interval = Whisker.low,
         Upper_confidence_interval = Whisker.high)

# on n'a pas l'information de l'erreur standard pour 2018
data2018_corrected <- data2018 %>%
  mutate(Year = 2018) %>%
  rename(Country = `Country or region`, 
         Happiness_score = Score, 
         Happiness_rank = `Overall rank`,
         Exp_by_economy_gdp_per_capita = `GDP per capita`,
         Explained_by_freedom = `Freedom to make life choices`, 
         Explained_by_trust_government = `Perceptions of corruption`, 
         Explained_by_social_support = `Social support`,
         Explained_by_life_expectancy = `Healthy life expectancy`,
         Explained_by_generosity = Generosity) %>% 
  mutate(Explained_by_trust_government = as.double(Explained_by_trust_government))

data2019_corrected <- data2019 %>%
  mutate(Year = 2019) %>%
  rename(Country =`Country or region`, 
         Happiness_score = Score, 
         Happiness_rank = `Overall rank`,
         Exp_by_economy_gdp_per_capita = `GDP per capita`,
         Explained_by_freedom = `Freedom to make life choices`, 
         Explained_by_trust_government = `Perceptions of corruption`, 
         Explained_by_social_support = `Social support`,
         Explained_by_life_expectancy = `Healthy life expectancy`,
         Explained_by_generosity = Generosity) 

data2020_corrected <- data2020 %>%
  mutate(Year = 2020) %>%
  rename(Happiness_score = `Ladder score`, 
         Country = `Country name`, 
         Regional_indicator = `Regional indicator`,
         Standard_error = `Standard error of ladder score`,
         Lower_confidence_interval = lowerwhisker, 
         Upper_confidence_interval = upperwhisker, 
         Logged_gpd_per_capita = `Logged GDP per capita`,
         Social_support = `Social support`,
         Life_expectancy = `Healthy life expectancy`,
         Freedom = `Freedom to make life choices`,
         Trust_government = `Perceptions of corruption`,
         Dystopia_score = `Ladder score in Dystopia`,
         Exp_by_economy_gdp_per_capita = `Explained by: Log GDP per capita`,
         Explained_by_social_support = `Explained by: Social support`,
         Explained_by_life_expectancy = `Explained by: Healthy life expectancy`, 
         Explained_by_freedom = `Explained by: Freedom to make life choices`, 
         Explained_by_generosity = `Explained by: Generosity`,
         Explained_by_trust_government = `Explained by: Perceptions of corruption`,
         Dystopia_residual = `Dystopia + residual`)

data2021_corrected <- data2021 %>%
  mutate(Year = 2021) %>%
  rename(Happiness_score = `Ladder score`, 
         Country = `Country name`, 
         Regional_indicator = `Regional indicator`,
         Standard_error = `Standard error of ladder score`,
         Lower_confidence_interval = lowerwhisker, 
         Upper_confidence_interval = upperwhisker, 
         Logged_gpd_per_capita = `Logged GDP per capita`,
         Social_support = `Social support`,
         Life_expectancy = `Healthy life expectancy`,
         Freedom = `Freedom to make life choices`,
         Trust_government = `Perceptions of corruption`,
         Dystopia_score = `Ladder score in Dystopia`,
         Exp_by_economy_gdp_per_capita = `Explained by: Log GDP per capita`,
         Explained_by_social_support = `Explained by: Social support`,
         Explained_by_life_expectancy = `Explained by: Healthy life expectancy`, 
         Explained_by_freedom = `Explained by: Freedom to make life choices`, 
         Explained_by_generosity = `Explained by: Generosity`,
         Explained_by_trust_government = `Explained by: Perceptions of corruption`,
         Dystopia_residual = `Dystopia + residual`)

# Fusion de tous les datasets

data <- data2015_corrected %>% 
  bind_rows(data2016_corrected) %>% 
  bind_rows(data2017_corrected) %>%
  bind_rows(data2018_corrected) %>%
  bind_rows(data2019_corrected) %>%
  bind_rows(data2020_corrected) %>%
  bind_rows(data2021_corrected)

# Complétion de la colonne "Region"

regions <- data2015_corrected %>% select("Country", "Region")

data <- merge(data, regions, by="Country")

data <- data %>% select(-"Region.x")
data <- data %>% rename("Region"="Region.y")

# Ajout des coordonnées géographiques

data <- merge(data, countries_corrected, by="Country")

# Ajout des données géographiques (shapefile)

data <- merge(data, world_map_corrected, by="Country")

```

## Est-ce que certaines régions du monde sont moins heureuses que d'autres ?

C'est ce que nous allons nous demander dans cette partie. Notre but est de déterminer si le bonheur a des préférences géographiques, et quels sont les critères qui rendent les populations de régions spécifiques plus heureuses que les autres.

## Idées de graphes à faire 

1. Un barchart qui indique le nombre de pays dont on a les données par région

2. Un boxplot qui indique le score de bonheur de chaque région

3. Une carte du monde colorée par région en fonction du score de bonheur (avec ggmap ou leaflet)

4. Faire des scatterplots pour les différents critères en fonction du niveau de bonheur par région (moyenne sur toutes les années ou évolution dans le temps ?)

```{r graphe 1 & 2}

# Nombre de pays par région dans le jeu de données
data %>%
  ggplot(aes(x = Region)) + geom_bar() + theme(axis.text.x = element_text(angle = 90))+ labs(x = "Region", y = "Number of countries")

# Les régions et leur score de bonheur (box plot)

data %>%
  ggplot(aes(x = Region, y = Happiness_score)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 90)) + labs(x = "Region", y = "Happiness Score")

```

```{r graphe 3}

# Carte du monde colorée en fonction du niveau de bonheur de chaque région

# Création de la fonction de palette numérique sur les scores de bonheur
mypalette <- colorNumeric(
  palette="magma", 
  domain=data2016_corrected$Happiness_score, 
  na.color="transparent")

map_regions <- leaflet() %>%
  addTiles() %>%
  # polygone des regions
  addPolygons(data = data$Geometry,
              label = data$Country,
              fillColor = mypalette(data2016_corrected$Happiness_score),
              weight = 2,
              opacity = 1,
              color = "white"
              )
map_regions

# data$Country[is.na(data$Geometry)]
data2016_corrected$Country[is.na(data$Happiness_score)]
```